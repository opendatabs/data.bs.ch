<div class="container-fluid">
    <ods-dataset-context context="wohnviertel,gesamtctx,viertelctx,sauberkeit,refinectx"
                         wohnviertel-dataset="100042" 
                         wohnviertel-parameters="{'sort':'wov_id','refine.gemeinde_name':'Basel'}" 
                         gesamtctx-dataset="100362"
                         gesamtctx-parameters="{'refine.wohnviertel': 'gesamtes Stadtgebiet'}"
                         viertelctx-dataset="100362"
                         viertelctx-parameters="{'exclude.wohnviertel': 'gesamtes Stadtgebiet'}"
                         sauberkeit-dataset="100362"
                         sauberkeit-parameters=""
                         refinectx-dataset="100362"
                         refinectx-parameters="{'sort':'-quartal',
                                                'disjunctive.wohnviertel':true,
                                                'disjunctive.quartal':true,
                                                'refine.wohnviertel': [refinectx.parameters['refine.wohnviertel'], 'gesamtes Stadtgebiet']}">
    <div>
        <div>
            <h2>
                Sauberkeitsindex für folgende Quartale: {{ sauberkeit.parameters['refine.quartal'] }}
            </h2>
            <div class="col-md-2">
                <ods-facets context="sauberkeit">
                    <ods-facet name="quartal" 
                               refine-also="[gesamtctx, viertelctx]"
                               gesamtctx-facet-name="quartal"
                               title="Quartal(e) wählen"
                               disjunctive="true">
                    </ods-facet>
                </ods-facets>
            </div>
            <div class="col-md-6"
                 ods-color-gradient="colorgradient"
                 ods-color-gradient-context="sauberkeit"
                 ods-color-gradient-x="wohnviertel"
                 ods-color-gradient-serie="AVG(ski)"
                 ods-color-gradient-high="rgb(20, 33, 96)"
                 ods-color-gradient-low="rgb(180, 197, 241)">
                <ods-map no-refit="true" 
                         scroll-wheel-zoom="false" 
                         basemap="9fffa5"
                         location="12,47.55689,7.58537">
                    <ods-map-layer-group>
                        <ods-map-layer context="sauberkeit" 
                                       color-categories="colorgradient['colors']"
                                       color-by-field="wohnviertel"
                                       color-categories-other="lightgrey"
                                       display="categories"
                                       shape-opacity="0.85"
                                       border-color="#FFFFFF" 
                                       border-opacity="1" 
                                       border-size="2" 
                                       border-pattern="solid" 
                                       title="Sauberkeitsindex pro Quartal und Wohnviertel" 
                                       description="Dieser Datensatz enthält den Sauberkeitsindex für alle Wohnviertel in der Stadt Basel. Zur Berechnung des Sauberkeitsindex wird wie folgt vorgegangen: " 
                                       refine-on-click-context="[refinectx, viertelctx]"
                                       refine-on-click-refinectx-replace-refine="true"
                                       refine-on-click-refinectx-map-field="wohnviertel"
                                       refine-on-click-refinectx-context-field="wohnviertel"
                                       refine-on-click-viertelctx-replace-refine="true"
                                       refine-on-click-viertelctx-map-field="wohnviertel"
                                       refine-on-click-viertelctx-context-field="wohnviertel">
                        </ods-map-layer>
                    </ods-map-layer-group>
                    <ods-map-layer-group>
                        <ods-map-layer context="refinectx"
                                       show-if="refinectx.parameters['refine.wohnviertel']"
                                       color="transparent"
                                       border-color="black"
                                       border-opacity="1"
                                       border-size="3">
                        </ods-map-layer>
                    </ods-map-layer-group>
                </ods-map>
            </div>
            <div class="col-md-4">
                <!-- KPI box component -->
                <div class="kpi-card">
                    <h2> gesamtes Stadtgebiet </h2>
                    <p class="kpi-title"
                       ods-aggregation="avggesamt"
                       ods-aggregation-context="gesamtctx"
                       ods-aggregation-function="AVG"
                       ods-aggregation-expression="ski">
                        {{ avggesamt | number : 2 }}
                    </p>
                    <p class="kpi-description">
                        Durchschnitt SKI gewählter Quartale
                    </p>
                </div>
                <div class="kpi-card">
                    <h2> Wohnviertel: {{ viertelctx.parameters['refine.wohnviertel'] }} </h2>
                    <p class="kpi-title"
                       ods-aggregation="avgviertel"
                       ods-aggregation-context="viertelctx"
                       ods-aggregation-function="AVG"
                       ods-aggregation-expression="ski">
                        {{ avgviertel | number : 2 }}
                    </p>
                    <p class="kpi-description">
                        Durchschnitt SKI gewählter Quartale
                    </p>
                </div>
            </div>
        </div>
        </div>
        <div ng-if="refinectx.parameters['refine.wohnviertel']">
            <div class="col-md-6">
                <h3>
                    Sauberkeitsindex pro Quartal
                </h3>
                <ods-chart scientific-display="false" 
                           align-month="true">
                    <ods-chart-query context="refinectx" 
                                     field-x="quartal" 
                                     maxpoints="0" 
                                     series-breakdown="wohnviertel">
                        <ods-chart-serie expression-y="ski"
                                         chart-type="line" 
                                         function-y="AVG" 
                                         color="range-Accent"
                                         scientific-display="true">
                        </ods-chart-serie>
                    </ods-chart-query>
                </ods-chart>
            </div>
            <div class="col-md-6">
                <h3>
                    Sauberkeitsindex pro Jahr
                </h3>
                <ods-chart scientific-display="false" 
                           align-month="true">
                    <ods-chart-query context="refinectx" 
                                     field-x="jahr" 
                                     maxpoints="0" 
                                     series-breakdown="wohnviertel">
                        <ods-chart-serie expression-y="ski"
                                         chart-type="line" 
                                         function-y="AVG" 
                                         color="range-Accent"
                                         scientific-display="true">
                        </ods-chart-serie>
                    </ods-chart-query>
                </ods-chart>
            </div>
        </div>
    </ods-dataset-context>
</div>
